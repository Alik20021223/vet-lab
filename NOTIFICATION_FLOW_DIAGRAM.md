# 📊 Схема работы системы уведомлений

## 🔄 Полный цикл обращения клиента

```
┌─────────────────────────────────────────────────────────────────┐
│                     КЛИЕНТ НА САЙТЕ                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │   Просматривает продукт или услугу      │
        │   Например: "Вакцина против бешенства"  │
        └─────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │   Нажимает кнопку                       │
        │   "СВЯЗАТЬСЯ С НАМИ"  [📞]              │
        └─────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   ФОРМА КОНТАКТА                                 │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  Ваше имя:      [_______________]  (обязательно)          │  │
│  │  Телефон:       [_______________]  (обязательно)          │  │
│  │  Email:         [_______________]  (опционально)          │  │
│  │  Сообщение:     [_______________]                         │  │
│  │                 [_______________]                         │  │
│  │                                                           │  │
│  │  ℹ️ По поводу: Вакцина против бешенства (авто)           │  │
│  │                                                           │  │
│  │                    [ОТПРАВИТЬ] 📤                         │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    BACKEND API                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │  POST /api/contact                                        │  │
│  │  {                                                        │  │
│  │    name: "Иван Петров",                                  │  │
│  │    phone: "+992 123 456 789",                            │  │
│  │    email: "ivan@example.com",                            │  │
│  │    message: "Хочу заказать партию",                      │  │
│  │    contextType: "product",                               │  │
│  │    contextId: "clxxx123",                                │  │
│  │    contextTitle: "Вакцина против бешенства"              │  │
│  │  }                                                        │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │   Сохранение в базу данных              │
        │   (таблица Contact)                     │
        └─────────────────────────────────────────┘
                              │
                              ▼
        ┌─────────────────────────────────────────┐
        │   Параллельная отправка уведомлений     │
        └─────────────────────────────────────────┘
                              │
                ┌─────────────┴─────────────┐
                │                           │
                ▼                           ▼
    ┌───────────────────┐       ┌───────────────────┐
    │   📱 TELEGRAM     │       │   📧 EMAIL        │
    └───────────────────┘       └───────────────────┘
                │                           │
                ▼                           ▼
    ┌───────────────────┐       ┌───────────────────┐
    │  Telegram API     │       │  SMTP Server      │
    │  sendMessage      │       │  (Gmail/Yandex)   │
    └───────────────────┘       └───────────────────┘
                │                           │
                ▼                           ▼
    ┌───────────────────┐       ┌───────────────────┐
    │  💬 Ваша группа   │       │  📮 Ваш почтовый  │
    │  или личка        │       │     ящик          │
    └───────────────────┘       └───────────────────┘
```

---

## 📱 Пример уведомления в Telegram

```
┌────────────────────────────────────────────────┐
│  VET-LAB Bot                              [×]  │
├────────────────────────────────────────────────┤
│                                                │
│  🔔 Новое обращение с сайта                   │
│                                                │
│  👤 Клиент: Иван Петров                       │
│  📞 Телефон: +992 123 456 789                 │
│  📧 Email: ivan@example.com                   │
│                                                │
│  📦 По продукту:                              │
│  Вакцина против бешенства                     │
│  Категория: Вакцины                           │
│                                                │
│  💬 Сообщение:                                │
│  Здравствуйте, хочу заказать партию для       │
│  нашей ветклиники. Интересует цена и          │
│  условия доставки.                            │
│                                                │
│  🕐 Дата: 13.12.2024, 15:30                   │
│                                                │
└────────────────────────────────────────────────┘
```

---

## 📧 Пример уведомления на Email

```
┌──────────────────────────────────────────────────────────┐
│  От: VET-LAB Notifications <notifications@gmail.com>    │
│  Кому: admin@vet-lab.tj                                  │
│  Тема: Новое обращение: Вакцина против бешенства        │
│  Дата: 13 декабря 2024, 15:30                           │
├──────────────────────────────────────────────────────────┤
│                                                          │
│  Добрый день!                                            │
│                                                          │
│  Получено новое обращение с сайта VET-LAB.              │
│                                                          │
│  ИНФОРМАЦИЯ О КЛИЕНТЕ                                    │
│  ─────────────────────────                              │
│  • Имя: Иван Петров                                     │
│  • Телефон: +992 123 456 789                            │
│  • Email: ivan@example.com                              │
│                                                          │
│  ТИП ОБРАЩЕНИЯ                                           │
│  ─────────────────                                      │
│  По продукту                                             │
│                                                          │
│  ПРОДУКТ                                                 │
│  ───────────                                            │
│  Название: Вакцина против бешенства                     │
│  Категория: Вакцины                                      │
│  Ссылка: https://vet-lab.tj/catalog/clxxx123            │
│                                                          │
│  СООБЩЕНИЕ КЛИЕНТА                                       │
│  ─────────────────────                                  │
│  Здравствуйте, хочу заказать партию для нашей           │
│  ветклиники. Интересует цена и условия доставки.        │
│                                                          │
│  ДАТА ОБРАЩЕНИЯ                                          │
│  ───────────────                                        │
│  13 декабря 2024 года, 15:30                            │
│                                                          │
│  ─────────────────────────────────────────────────      │
│  Автоматическое уведомление от VET-LAB                  │
│  Не отвечайте на это письмо                             │
└──────────────────────────────────────────────────────────┘
```

---

## 🗄️ Структура базы данных

```sql
-- Таблица Contact (обновленная)
CREATE TABLE Contact (
  id          String   PRIMARY KEY,
  
  -- Информация о клиенте
  name        String   NOT NULL,
  email       String   NULL,
  phone       String   NULL,
  message     String   NOT NULL,
  
  -- Контекст обращения (НОВОЕ!)
  contextType String   NULL,        -- "product" | "service" | "general"
  contextId   String   NULL,        -- ID продукта или услуги
  contextTitle String  NULL,        -- Название для удобства
  
  -- Метаданные
  status      String   DEFAULT "new",  -- "new" | "read" | "replied"
  createdAt   DateTime DEFAULT now(),
  updatedAt   DateTime
);
```

---

## 🎯 Типы обращений

```
┌────────────────────────────────────────────────────┐
│  Тип обращения: ПРОДУКТ                            │
├────────────────────────────────────────────────────┤
│  contextType: "product"                            │
│  contextId: "clxxx123"                             │
│  contextTitle: "Вакцина против бешенства"          │
│                                                    │
│  Клиент нажал кнопку на странице продукта          │
│  /catalog/clxxx123                                 │
└────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────┐
│  Тип обращения: УСЛУГА                             │
├────────────────────────────────────────────────────┤
│  contextType: "service"                            │
│  contextId: "clyyy456"                             │
│  contextTitle: "Лабораторные исследования"         │
│                                                    │
│  Клиент нажал кнопку на странице услуги            │
│  /services/clyyy456                                │
└────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────┐
│  Тип обращения: ОБЩЕЕ                              │
├────────────────────────────────────────────────────┤
│  contextType: null                                 │
│  contextId: null                                   │
│  contextTitle: null                                │
│                                                    │
│  Клиент заполнил форму на странице /contacts       │
│  без конкретного продукта или услуги               │
└────────────────────────────────────────────────────┘
```

---

## 🔐 Безопасность и надежность

```
┌──────────────────────────────────────────────┐
│  КЛИЕНТ                                      │
└──────────────────────────────────────────────┘
          │
          ▼ HTTPS + CORS защита
┌──────────────────────────────────────────────┐
│  BACKEND API                                 │
│  ✅ Валидация полей                          │
│  ✅ Санитизация данных                       │
│  ✅ Rate limiting                            │
└──────────────────────────────────────────────┘
          │
          ▼ Транзакция БД
┌──────────────────────────────────────────────┐
│  DATABASE                                    │
│  ✅ Сохранение обращения                     │
└──────────────────────────────────────────────┘
          │
          ▼ Promise.allSettled
┌─────────────────┬────────────────────────────┐
│  TELEGRAM       │  EMAIL                     │
│  ⚠️ Если ошибка │  ⚠️ Если ошибка            │
│  → логируется   │  → логируется              │
│  → не падает    │  → не падает               │
└─────────────────┴────────────────────────────┘
          │
          ▼ Всегда успешный ответ клиенту
┌──────────────────────────────────────────────┐
│  КЛИЕНТ                                      │
│  ✅ "Спасибо! Мы свяжемся с вами"            │
└──────────────────────────────────────────────┘
```

---

## 📊 Админ-панель

```
┌────────────────────────────────────────────────────────────────┐
│  VET-LAB Admin Panel - Обращения клиентов                      │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  Фильтры: [Все ▼]  [Продукты]  [Услуги]  [Общие]             │
│  Статус:  [Новые ▼]  [Прочитанные]  [Отвеченные]             │
│                                                                │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │ 🟢 NEW  │ 13.12.2024, 15:30                              │ │
│  │ Иван Петров (+992 123 456 789)                          │ │
│  │ 📦 Продукт: Вакцина против бешенства                    │ │
│  │ Хочу заказать партию для нашей ветклиники...            │ │
│  │                          [Прочитано] [Ответить] [×]     │ │
│  └──────────────────────────────────────────────────────────┘ │
│                                                                │
│  ┌──────────────────────────────────────────────────────────┐ │
│  │ 🔵 READ │ 13.12.2024, 14:15                              │ │
│  │ Мария Иванова (+992 987 654 321)                        │ │
│  │ 💼 Услуга: Лабораторные исследования                    │ │
│  │ Интересуют цены на анализы крови...                     │ │
│  │                          [Ответить] [Архив] [×]         │ │
│  └──────────────────────────────────────────────────────────┘ │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

---

## 🚀 Последовательность реализации

```
Шаг 1: Настройка окружения
├─ ✅ Создать Telegram бота
├─ ✅ Получить Chat ID
├─ ✅ Настроить SMTP
└─ ✅ Заполнить .env

Шаг 2: Backend разработка
├─ 📦 Установка пакетов (nodemailer, node-telegram-bot-api)
├─ 🗄️ Обновление Prisma схемы
├─ 🔧 Утилиты для Telegram и Email
├─ 🎯 Обновление Contact API
└─ ✅ Тестирование отправки

Шаг 3: Frontend разработка
├─ 🎨 Кнопка "Связаться" на страницах продуктов
├─ 🎨 Кнопка "Связаться" на страницах услуг
├─ 📝 Обновление формы контакта
├─ 🔌 Интеграция с API
└─ 🌐 Добавление переводов (i18n)

Шаг 4: Тестирование
├─ ✅ Тест отправки из формы продукта
├─ ✅ Тест отправки из формы услуги
├─ ✅ Тест общей формы
├─ ✅ Проверка Telegram уведомлений
└─ ✅ Проверка Email уведомлений

Шаг 5: Деплой
├─ 📤 Обновление .env.production
├─ 🚀 Деплой на сервер
└─ ✅ Финальное тестирование
```

---

**Готовы начать?** → [QUICK_SETUP_CHECKLIST.md](./QUICK_SETUP_CHECKLIST.md)
